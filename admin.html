// ===== OPEN ADMIN PANEL =====
document.getElementById("openAdminDeposit").onclick = async () => {
  document.getElementById("adminDepositPanel").style.display = "flex";
  loadDepositRequests(); // Load requests when admin opens panel
};

// ===== CLOSE ADMIN PANEL =====
document.getElementById("closeAdminDeposit").onclick = () => {
  document.getElementById("adminDepositPanel").style.display = "none";
};

// ===== LOAD DEPOSIT REQUESTS =====
async function loadDepositRequests(filter = "") {
  const container = document.getElementById("depositRequestsContainer");
  container.innerHTML = "Loading...";

  const querySnapshot = await getDocs(collection(db, "deposits"));
  container.innerHTML = "";

  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;

    // Simple filter
    if (
      filter &&
      !(
        data.senderNumber.includes(filter) ||
        data.uid.includes(filter) ||
        (data.senderName && data.senderName.toLowerCase().includes(filter.toLowerCase()))
      )
    ) return;

    const div = document.createElement("div");
    div.style = "border:1px solid #cbd5f5; padding:12px; margin-bottom:8px; border-radius:12px;";

    div.innerHTML = `
      <p><b>User:</b> ${data.name} (UID: ${data.uid})</p>
      <p><b>Amount:</b> ${data.amount}</p>
      <p><b>Wallet:</b> ${data.walletType} - ${data.adminWallet}</p>
      <p><b>Sender:</b> ${data.senderName} - ${data.senderNumber}</p>
      <p><b>Status:</b> ${data.status}</p>
      <div style="display:flex; gap:10px; margin-top:6px;">
        <button style="flex:1; background:#22c55e; color:#fff; padding:6px; border:none; border-radius:8px; cursor:pointer;" class="approve-btn">Approve</button>
        <button style="flex:1; background:#ef4444; color:#fff; padding:6px; border:none; border-radius:8px; cursor:pointer;" class="reject-btn">Reject</button>
      </div>
    `;

    container.appendChild(div);

    // Approve Button
    div.querySelector(".approve-btn").onclick = async () => {
      const userRef = doc(db, "users", data.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const userData = userSnap.data();
        await updateDoc(userRef, { balance: Number(userData.balance) + Number(data.amount) });
      }

      await deleteDoc(doc(db, "deposits", id)); // Remove request from Firestore
      loadDepositRequests(filter); // Refresh list
      alert("Deposit Approved ✅");
    };

    // Reject Button
    div.querySelector(".reject-btn").onclick = async () => {
      await deleteDoc(doc(db, "deposits", id));
      loadDepositRequests(filter); // Refresh list
      alert("Deposit Rejected ❌");
    };
  });

  if (!container.innerHTML) {
    container.innerHTML = "<p style='text-align:center;color:#888;'>No deposit requests found.</p>";
  }
}

// ===== SEARCH DEPOSIT =====
document.getElementById("searchDeposit").addEventListener("input", (e) => {
  const value = e.target.value.trim();
  loadDepositRequests(value);
});
