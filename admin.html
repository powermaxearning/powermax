<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PowerMax Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui}
body{background:#020617;color:#f8fafc}
h2{text-align:center;margin:20px 0;color:#38bdf8}
.section{margin:20px auto;max-width:700px}
.card{border:1px solid #334155;border-radius:14px;padding:14px;margin-bottom:12px;background:#020617}
.actions{display:flex;gap:10px;margin-top:10px}
button{flex:1;padding:8px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
.approve{background:#22c55e}
.reject{background:#ef4444;color:#fff}
button:disabled{opacity:.6;cursor:not-allowed}
.deposit-title{
  font-size: 28px;       /* Ø§ÛŒÚ© Ù„Ø§Ø¦Ù† Ù…ÛŒÚº Ø¢ Ø¬Ø§Ø¦Û’ Ú¯Ø§ */
  font-weight: 800;
  color: #22c55e;
  display: flex;
  align-items: center;
  gap: 8px;              /* Ø¢Ø¦ÛŒÚ©Ù† Ø§ÙˆØ± text Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† ØªÚ¾ÙˆÚ‘Ø§ gap */
  margin-bottom: 16px;
}

.withdraw-title{
  font-size: 28px;       /* Ø§ÛŒÚ© Ù„Ø§Ø¦Ù† Ù…ÛŒÚº Ø¢ Ø¬Ø§Ø¦Û’ Ú¯Ø§ */
  font-weight: 800;
  color: #ef4444;
  display: flex;
  align-items: center;
  gap: 8px;              /* Ø¢Ø¦ÛŒÚ©Ù† Ø§ÙˆØ± text Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† ØªÚ¾ÙˆÚ‘Ø§ gap */
  margin-bottom: 16px;
}
</style>
</head>

<body>

<h2>âš¡ PowerMax Admin Panel âš¡</h2>

<div class="section">
  <h3 class="deposit-title">ğŸ’° Deposit Requests</h3>
  <div id="depositList">Loading...</div>
</div>

<div class="section">
  <h3 class="withdraw-title">ğŸ’¸ Withdraw Requests</h3>
  <div id="withdrawList">Loading...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, getDoc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuzjRv0Q1N4az6WPAQpGffAtZGT3Z-GxA",
  authDomain: "powermax-3ea77.firebaseapp.com",
  projectId: "powermax-3ea77"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= DEPOSIT ================= */
async function loadDeposits(){
  const box = document.getElementById("depositList");
  box.innerHTML = "";

  const snap = await getDocs(collection(db,"deposits"));
  snap.forEach(d=>{
    const data = d.data();
    let isProcessing = false;

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <p><b>User:</b> ${data.name} (${data.uid})</p>
      <p><b>Amount:</b> ${data.amount}</p>
      <p><b>From:</b> ${data.senderName} - ${data.senderNumber}</p>
      <p><b>Wallet:</b> ${data.walletType}</p>
      <div class="actions">
        <button class="approve">Approve</button>
        <button class="reject">Reject</button>
      </div>
    `;
    box.appendChild(div);

    const approveBtn = div.querySelector(".approve");
    const rejectBtn  = div.querySelector(".reject");

    // APPROVE â†’ ADD BALANCE (SAFE)
    approveBtn.onclick = async ()=>{
      if(isProcessing) return;
      isProcessing = true;

      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      approveBtn.innerText = "Processing...";

      try{
        const userRef = doc(db,"users",data.uid);
        const userSnap = await getDoc(userRef);
        if(!userSnap.exists()) return alert("User not found");

        const amount = Number(data.amount.replace(" PTS",""));
        await updateDoc(userRef,{
          balance:(userSnap.data().balance||0)+amount
        });

        await deleteDoc(doc(db,"deposits",d.id));
        loadDeposits();
        alert("Deposit Approved âœ…");
      }catch(e){
        console.error(e);
        alert("Error");
      }
    };

    // REJECT (SAFE)
    rejectBtn.onclick = async ()=>{
      if(isProcessing) return;
      isProcessing = true;

      approveBtn.disabled = true;
      rejectBtn.disabled = true;

      await deleteDoc(doc(db,"deposits",d.id));
      loadDeposits();
      alert("Deposit Rejected âŒ");
    };
  });
}

/* ================= WITHDRAW ================= */
async function loadWithdraws(){
  const box = document.getElementById("withdrawList");
  box.innerHTML = "";

  const snap = await getDocs(collection(db,"withdraws"));
  snap.forEach(d=>{
    const data = d.data();
    let isProcessing = false;

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <p><b>User:</b> ${data.name} (${data.uid})</p>
      <p><b>Amount:</b> ${data.amount} PTS</p>
      <p><b>Method:</b> ${data.method}</p>
      <p><b>Account:</b> ${data.ownerName} - ${data.accountNumber}</p>
      <div class="actions">
        <button class="approve">Approve</button>
        <button class="reject">Reject</button>
      </div>
    `;
    box.appendChild(div);

    const approveBtn = div.querySelector(".approve");
    const rejectBtn  = div.querySelector(".reject");

    // APPROVE â†’ MINUS BALANCE (SAFE)
    approveBtn.onclick = async ()=>{
      if(isProcessing) return;
      isProcessing = true;

      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      approveBtn.innerText = "Processing...";

      try{
        const userRef = doc(db,"users",data.uid);
        const userSnap = await getDoc(userRef);
        if(!userSnap.exists()) return alert("User not found");

        const bal = Number(userSnap.data().balance||0);
        const amount = Number(data.amount);

        if(bal < amount) return alert("Insufficient balance");

        await updateDoc(userRef,{ balance: bal - amount });
        await deleteDoc(doc(db,"withdraws",d.id));

        loadWithdraws();
        alert("Withdraw Approved âœ…");
      }catch(e){
        console.error(e);
        alert("Error");
      }
    };

    // REJECT (SAFE)
    rejectBtn.onclick = async ()=>{
      if(isProcessing) return;
      isProcessing = true;

      approveBtn.disabled = true;
      rejectBtn.disabled = true;

      await deleteDoc(doc(db,"withdraws",d.id));
      loadWithdraws();
      alert("Withdraw Rejected âŒ");
    };
  });
}

loadDeposits();
loadWithdraws();
</script>

</body>
</html>
